<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>microApi.js - lj-utils</title>
    
    <meta name="description" content="A clean, responsive documentation template theme for JSDoc 3." />
    
        <meta name="keywords" content="jsdoc, docdash,lj-utils" />
        <meta name="keyword" content="jsdoc, docdash,lj-utils" />
    
    
    
    <meta property="og:title" content="Docdash"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://cloud.githubusercontent.com/assets/447956/13398144/4dde7f36-defd-11e5-8909-1a9013302cb9.png"/>
    <meta property="og:site_name" content="Docdash"/>
    <meta property="og:url" content="http://clenemt.github.io/docdash/"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/LinJieLinLin/utils" target="_blank" class="menu-item" id="Github" >Github repo</a></h2><h2><a href="https://gitee.com/uni-pro/utils" target="_blank" class="menu-item" id="Gitee" >Gitee repo</a></h2><h2><a href="../coverage/index.html" target="_blank" class="menu-item" id="coverage" >coverage</a></h2><h3>Classes</h3><ul><li><a href="CanvasClass.html">CanvasClass</a><ul class='methods'><li data-type='method'><a href="CanvasClass.html#draw">draw</a></li><li data-type='method'><a href="CanvasClass.html#getScale">getScale</a></li></ul></li><li><a href="Counter.html">Counter</a><ul class='methods'><li data-type='method'><a href="Counter.html#setCount">setCount</a></li><li data-type='method'><a href="Counter.html#setMaxCount">setMaxCount</a></li><li data-type='method'><a href="Counter.html#start">start</a></li><li data-type='method'><a href="Counter.html#stop">stop</a></li></ul></li><li><a href="Debounce.html">Debounce</a><ul class='methods'><li data-type='method'><a href="Debounce.html#debounce">debounce</a></li></ul></li><li><a href="Loading.html">Loading</a><ul class='methods'><li data-type='method'><a href="Loading.html#loading">loading</a></li></ul></li><li><a href="Throttle.html">Throttle</a><ul class='methods'><li data-type='method'><a href="Throttle.html#throttle">throttle</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-encrypt_base64.html">encrypt/base64</a><ul class='methods'><li data-type='method'><a href="module-encrypt_base64.html#.deBase64">deBase64</a></li><li data-type='method'><a href="module-encrypt_base64.html#.enBase64">enBase64</a></li></ul></li><li><a href="module-encrypt_crypto.html">encrypt/crypto</a><ul class='methods'><li data-type='method'><a href="module-encrypt_crypto.html#.aesInit">aesInit</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.deAes">deAes</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.deBase64">deBase64</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.decode">decode</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.enAes">enAes</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.enBase64">enBase64</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.encode">encode</a></li><li data-type='method'><a href="module-encrypt_crypto.html#.md5">md5</a></li></ul></li><li><a href="module-index.html">index</a><ul class='methods'><li data-type='method'><a href="module-index.html#.blobToBase64">blobToBase64</a></li><li data-type='method'><a href="module-index.html#.blobToFile">blobToFile</a></li><li data-type='method'><a href="module-index.html#.blobUrlToFile">blobUrlToFile</a></li><li data-type='method'><a href="module-index.html#.dataURLtoBlob">dataURLtoBlob</a></li><li data-type='method'><a href="module-index.html#.decodeHtml">decodeHtml</a></li><li data-type='method'><a href="module-index.html#.delCookie">delCookie</a></li><li data-type='method'><a href="module-index.html#.dlFile">dlFile</a></li><li data-type='method'><a href="module-index.html#.encodeHtml">encodeHtml</a></li><li data-type='method'><a href="module-index.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-index.html#.formatSize">formatSize</a></li><li data-type='method'><a href="module-index.html#.formatTime">formatTime</a></li><li data-type='method'><a href="module-index.html#.friendlyTime">friendlyTime</a></li><li data-type='method'><a href="module-index.html#.getCookie">getCookie</a></li><li data-type='method'><a href="module-index.html#.getDuration">getDuration</a></li><li data-type='method'><a href="module-index.html#.getInfo">getInfo</a></li><li data-type='method'><a href="module-index.html#.getNetworkStatus">getNetworkStatus</a></li><li data-type='method'><a href="module-index.html#.getRandomColor">getRandomColor</a></li><li data-type='method'><a href="module-index.html#.getRegexp">getRegexp</a></li><li data-type='method'><a href="module-index.html#.getStorage">getStorage</a></li><li data-type='method'><a href="module-index.html#.getUrlParam">getUrlParam</a></li><li data-type='method'><a href="module-index.html#.getUrlParamObj">getUrlParamObj</a></li><li data-type='method'><a href="module-index.html#.getUuid">getUuid</a></li><li data-type='method'><a href="module-index.html#.hideInfo">hideInfo</a></li><li data-type='method'><a href="module-index.html#.isBlob">isBlob</a></li><li data-type='method'><a href="module-index.html#.isFile">isFile</a></li><li data-type='method'><a href="module-index.html#.isIdCard">isIdCard</a></li><li data-type='method'><a href="module-index.html#.isJson">isJson</a></li><li data-type='method'><a href="module-index.html#.isPrime">isPrime</a></li><li data-type='method'><a href="module-index.html#.loadFile">loadFile</a></li><li data-type='method'><a href="module-index.html#.px2vw">px2vw</a></li><li data-type='method'><a href="module-index.html#.randomInt">randomInt</a></li><li data-type='method'><a href="module-index.html#.remInit">remInit</a></li><li data-type='method'><a href="module-index.html#.replaceUrlParam">replaceUrlParam</a></li><li data-type='method'><a href="module-index.html#.rmbPrice">rmbPrice</a></li><li data-type='method'><a href="module-index.html#.safeData">safeData</a></li><li data-type='method'><a href="module-index.html#.secondToTime">secondToTime</a></li><li data-type='method'><a href="module-index.html#.setCookie">setCookie</a></li><li data-type='method'><a href="module-index.html#.setStorage">setStorage</a></li><li data-type='method'><a href="module-index.html#.setTitle">setTitle</a></li><li data-type='method'><a href="module-index.html#.setUrlParams">setUrlParams</a></li><li data-type='method'><a href="module-index.html#.sleep">sleep</a></li><li data-type='method'><a href="module-index.html#.string10to62">string10to62</a></li><li data-type='method'><a href="module-index.html#.string62to10">string62to10</a></li><li data-type='method'><a href="module-index.html#.toFixed">toFixed</a></li><li data-type='method'><a href="module-index.html#.toHump">toHump</a></li><li data-type='method'><a href="module-index.html#.toLine">toLine</a></li></ul></li><li></li><li></li><li></li><li></li><li><a href="module-microApi.html">microApi</a><ul class='methods'><li data-type='method'><a href="module-microApi.html#.checkSetting">checkSetting</a></li><li data-type='method'><a href="module-microApi.html#.checkUpdate">checkUpdate</a></li><li data-type='method'><a href="module-microApi.html#.chooseImage">chooseImage</a></li><li data-type='method'><a href="module-microApi.html#.clearStorageSync">clearStorageSync</a></li><li data-type='method'><a href="module-microApi.html#.cloudApi">cloudApi</a></li><li data-type='method'><a href="module-microApi.html#.downloadImgs">downloadImgs</a></li><li data-type='method'><a href="module-microApi.html#.getCurrentPage">getCurrentPage</a></li><li data-type='method'><a href="module-microApi.html#.getCurrentPageUrl">getCurrentPageUrl</a></li><li data-type='method'><a href="module-microApi.html#.getDb">getDb</a></li><li data-type='method'><a href="module-microApi.html#.getLocation">getLocation</a></li><li data-type='method'><a href="module-microApi.html#.getRichText">getRichText</a></li><li data-type='method'><a href="module-microApi.html#.getStorage">getStorage</a></li><li data-type='method'><a href="module-microApi.html#.getStorageSync">getStorageSync</a></li><li data-type='method'><a href="module-microApi.html#.getStorageSyncForVuex">getStorageSyncForVuex</a></li><li data-type='method'><a href="module-microApi.html#.getSystemInfo">getSystemInfo</a></li><li data-type='method'><a href="module-microApi.html#.getUserInfo">getUserInfo</a></li><li data-type='method'><a href="module-microApi.html#.hideLoading">hideLoading</a></li><li data-type='method'><a href="module-microApi.html#.init">init</a></li><li data-type='method'><a href="module-microApi.html#.ljApiFn">ljApiFn</a></li><li data-type='method'><a href="module-microApi.html#.ljLog">ljLog</a></li><li data-type='method'><a href="module-microApi.html#.log">log</a></li><li data-type='method'><a href="module-microApi.html#.login">login</a></li><li data-type='method'><a href="module-microApi.html#.P">P</a></li><li data-type='method'><a href="module-microApi.html#.refresh">refresh</a></li><li data-type='method'><a href="module-microApi.html#.request">request</a></li><li data-type='method'><a href="module-microApi.html#.requestCloud">requestCloud</a></li><li data-type='method'><a href="module-microApi.html#.scrollTop">scrollTop</a></li><li data-type='method'><a href="module-microApi.html#.setRequest">setRequest</a></li><li data-type='method'><a href="module-microApi.html#.setStorage">setStorage</a></li><li data-type='method'><a href="module-microApi.html#.setTitle">setTitle</a></li><li data-type='method'><a href="module-microApi.html#.showLoading">showLoading</a></li><li data-type='method'><a href="module-microApi.html#.toast">toast</a></li><li data-type='method'><a href="module-microApi.html#.toPage">toPage</a></li><li data-type='method'><a href="module-microApi.html#.uploadImg">uploadImg</a></li><li data-type='method'><a href="module-microApi.html#.uploadImgs">uploadImgs</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">microApi.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module
 * @author linj
 * @description 微信小程序/uniapp/taro公共函数
 */

/* eslint-disable no-constant-condition,no-undef */
import Loading from './class/Loading'
import Throttle from './class/Throttle'
import { decode, encode } from './encrypt/base64'
import { isJson } from './is'
import { safeData, setUrlParams } from './data'
import { blobToFile, dataURLtoBlob } from './file'
import { sleep } from './base'
let frame = ''
let app = {}
let appConfig = {
  localEncrypt: false,
}
let ljCloud = ''

if (typeof uni !== 'undefined') {
  app = uni
  frame = 'uni'
} else if (typeof taro !== 'undefined') {
  app = taro
  frame = 'taro'
} else if (typeof wx !== 'undefined') {
  app = wx
  frame = 'wx'
}
// 初始化loading
const L = new Loading(() => {
  app.showLoading({
    mask: true,
  })
}, app.hideLoading)
// 函数节流
const throttle = new Throttle()
/**
 * @description 默认拦截函数obj
 */
const interceptors = {
  request(argData) {
    L.loading(1)
    return argData
  },
  async response(argData) {
    L.loading()
    return argData
  },
}

/**
 * @description 获取unicloud DB
 * @function
 */
export const getDb = () => {
  return ljCloud.database()
}
/**
 * @description 初始化配置
 * @function
 * @param {object} argConfig
 * @param {boolean} argConfig.localEncrypt 本地缓存是否加密
 */
export const init = (argConfig = {}) => {
  Object.assign(appConfig, argConfig)
  if (typeof uniCloud !== 'undefined' &amp;&amp; appConfig.uniCloud) {
    // console.error(appConfig.uniCloud)
    ljCloud = uniCloud.init(appConfig.uniCloud)
  }
}
/**
 * @description 显示loading
 * @function
 */
export const showLoading = () => {
  L.loading(1)
}
/**
 * @description 隐藏loading
 * @function
 */
export const hideLoading = () => {
  L.loading()
}
/**
 * @description 修改设置拦截函数
 * @function
 * @param {function} argRequest 请求拦截
 * @param {argResponse} argRequest 响应拦截
 */
export const setRequest = (argRequest, argResponse) => {
  if (typeof argRequest === 'function') {
    interceptors.request = (argData) => {
      L.loading(1)
      return argRequest(argData)
    }
  }
  if (typeof argResponse === 'function') {
    interceptors.response = (argData) => {
      L.loading()
      return argResponse(argData)
    }
  }
}
/**
 * @description 使用ljapi
 * @function
 * @param {object} argOption 传入参数
 * @returns {argOption} 返回修改后的参数
 */
export const ljApiFn = (argOption) => {
  argOption.params = Object.assign(
    {
      path: argOption.url,
      data: safeData(argOption, 'params.data', {}),
    },
    JSON.parse(process.env.VUE_APP_LJAPIC)
  )
  argOption.params.type = process.env.VUE_APP_LJAPITYPE
  argOption.url = process.env.VUE_APP_LJAPIURL
  // argOption.method = 'GET'
  argOption.method = 'POST'
  return argOption
}
/**
 * @description 封装小程序request
 * @function
 * @param {object} argOption http配置
 * @returns {promise}
 */
export const request = async (argOption, argIsMock) => {
  let apiUrl = argOption.url
  if (process.env.VUE_APP_LJAPITYPE === 'get' || argIsMock) {
    argOption = ljApiFn(argOption, argOption.params.data)
  } else {
    argOption = await interceptors.request(argOption)
  }
  return new Promise((resolve, reject) => {
    const config = {
      url: argOption.url,
      method: argOption.method || 'GET',
      data: argOption.params,
      success(res = {}) {
        console.log('响应数据：', res)
        if (!argIsMock &amp;&amp; process.env.VUE_APP_LJAPITYPE === 'set') {
          argOption.url = apiUrl
          argOption.params.data = JSON.stringify(res.data)
          request(argOption, 1)
        }
        res.config = argOption.config || {}
        return resolve(interceptors.response(res))
      },
      fail(err) {
        return reject(interceptors.response(err))
      },
    }
    Object.assign(config, argOption.config)
    app.request(config)
  })
}
/**
 * @description 图片上传 单图/多图
 * @function
 * @param {object} argOption 参数配置
 * @returns {promise} 上传回调
 */
export const uploadImg = async (argOption) => {
  var error, filePath
  argOption.config = argOption.config || {}
  var data = {
    url: argOption.params.url,
    filePath: '',
    name: argOption.params.name || 'file',
    formData: null,
    header: argOption.config.header || {},
  }
  filePath = argOption.params.filePath
  const uploadOne = async (argPath) => {
    data.filePath = argPath
    let res = await P('uploadFile', data).catch((err) => {
      error = err
    })
    // #ifdef  H5
    URL.revokeObjectURL(argPath)
    // #endif
    if (res) {
      res.data = JSON.parse(res.data)
      return response(res)
    } else {
      return Promise.reject(error)
    }
  }

  delete argOption.params.url
  delete argOption.params.filePath
  delete argOption.params.name
  delete argOption.config.header['content-type']

  argOption = interceptors.request(argOption)
  data.formData = argOption.params
  data.header = argOption.config.header || {}
  // 单张上传
  if (typeof filePath === 'string') {
    return uploadOne(filePath)
  } else {
    const temUploadFn = filePath.map(uploadOne)
    res = await Promise.all(temUploadFn).catch((err) => {
      error = err
    })
    if (res) {
      return res
    } else {
      return Promise.reject(error)
    }
  }
}

/**
 * @function
 * @description 请求云函数
 * @param {object} argOption
 * @param {string} argOption.name 云函数名
 * @param {object} argOption.params 参数
 * @param {object} argOption.config 请求配置
 * }
 */
export const requestCloud = async (argOption) => {
  argOption = interceptors.request(argOption)
  let e
  let res = await ljCloud
    .callFunction({
      name: argOption.name,
      data: argOption.params,
    })
    .catch((err) => {
      e = err
    })
  if (!res) {
    res = e
  }
  res.config = argOption.config || {}
  return interceptors.response(res)
}
/**
 * @function
 * @description 检查是否有更新
 */
export const checkUpdate = () => {
  console.log('检查更新，有更新会提示更新')
  if (!app.getUpdateManager) {
    return
  }
  const updateManager = app.getUpdateManager()
  updateManager.onUpdateReady(function () {
    app.showModal({
      title: '更新提示',
      content: '新版本已经准备好，是否重启应用？',
      success: function (res) {
        if (res.confirm) {
          // 新的版本已经下载好，调用 applyUpdate 应用新版本并重启
          updateManager.applyUpdate()
        }
      },
    })
  })
}
/**
 * @function
 * @description 检查用户授权状态，未授权弹出授权，(userInfo除外)，将拿到的权限放在authSetting 中
 * @param {string} argSet 要检查的权限,userInfo时：已授权会返回userInfo数据
 * @returns {promise}
 */
export const checkSetting = (argSet) => {
  app.removeStorage({
    key: 'authSetting',
  })
  return new Promise(function (resolve, reject) {
    app.getSetting({
      success(res) {
        app.setStorageSync('authSetting', res.authSetting)
        if (!res.authSetting['scope.' + argSet]) {
          if (argSet === 'userInfo') {
            return reject(new Error('未授权用户信息'))
          }
          app.authorize({
            scope: 'scope.' + argSet,
            success(rs) {
              return resolve(rs)
            },
            fail(err) {
              return reject(err)
            },
          })
        } else {
          if (argSet === 'userInfo') {
            app.getUserInfo({
              success: (res) => {
                return resolve(res)
              },
              fail: (err) => {
                return reject(err)
              },
            })
          } else {
            return resolve(res)
          }
        }
      },
      fail(err) {
        return reject(err)
      },
    })
  })
}

/**
 * @description 获取地理位置 (类型，)
 * @function
 * @param {string} argType 类型
 * @param {boolean} argAltitude 是否高精度
 * @returns {promise}
 */
export const getLocation = (argType = 'gcj02', argAltitude = false) => {
  const location = () => {
    return new Promise(function (resolve, reject) {
      app.getLocation({
        altitude: argAltitude,
        type: argType,
        success: (res) => {
          console.log(res)
          return resolve(res)
        },
        fail: (err) => {
          return reject(err)
        },
      })
    })
  }
  const re = async () => {
    try {
      await checkSetting('userLocation')
      const re = await location()
      return re
    } catch (err) {
      if (err.errMsg) {
        app.show({
          title: '您已拒绝地理位置授权,可以在设置中重新打开',
          icon: 'none',
        })
      }
      return Promise.reject(err)
    }
  }
  return re()
}

/**
 * @description 回到顶部/某个位置
 * @function
 * @param {number} scrollTop 滚动距离
 * @param {number} duration 时间
 * @returns {promise}
 */
export const scrollTop = (scrollTop = 0, duration = 0) => {
  app.pageScrollTo({
    scrollTop: scrollTop,
    duration: duration,
  })
}

/**
 * @description toast默认为文字提示,默认推迟320ms显示
 * @function
 * @param {string} argTitle title
 * @param {object} argOption{
 * icon:'图标',
 * delay: '延时显示'
 * duration："显示时间""
 * } toast 的option
 * @returns {promise}
 */
export const toast = (
  argTitle,
  argOption = {
    icon: 'none',
    delay: 320,
    duration: 3000,
  }
) => {
  return new Promise(async function (resolve, reject) {
    Object.assign(argOption, {
      title: argTitle,
      success: async () => {
        await sleep(argOption.duration || 5000)
        return resolve()
      },
      fail: (err) => {
        return reject(err)
      },
    })
    if (argOption.delay) {
      await sleep(argOption.delay)
      return app.showToast(argOption)
    } else {
      return app.showToast(argOption)
    }
  })
}

/**
 * @function
 * @description 设置标题
 * @param  {} argTitle 标题
 */
export const setTitle = (argTitle) => {
  app.setNavigationBarTitle({
    title: argTitle,
  })
}

/**
 * @function
 * @description mpvue跳到特定页面
 * @param  {string} argPage 标题
 * @param  {object} argParams url参数
 * @param  {string|number} argType 跳转类型 switchTab reload redirectTo reLaunch navigateTo
 * @param {boolean} argForce 是否取消节流非H5生效
 */
export const toPage = (argPage, argParams = {}, argType, argForce = false) => {
  const toPageFn = () => {
    console.log(
      'toPage params:',
      argPage,
      setUrlParams(argParams),
      argType,
      argForce
    )
    // 后退处理
    let pages = null
    if (!argPage || argPage === 'back') {
      // -1时返回首页
      // #ifndef  H5
      pages = getCurrentPages()
      if (pages.length > 1 &amp;&amp; argType !== '-1') {
        app.navigateBack({
          delta: +argType || 1,
        })
      } else {
        app.reLaunch({
          url: '/pages/index/index' + setUrlParams(argParams),
        })
      }
      // #endif
      // #ifdef  H5
      window.history.go(+('-' + (argType || 1)))
      // #endif
      return
    }
    // 每次进入首页都重载
    if (argPage === 'index' || argPage === '/pages/index/index') {
      app.reLaunch({
        url: '/pages/' + argPage + '/index' + setUrlParams(argParams),
      })
      return
    }
    let type = ''
    let temUrl = '/pages/' + argPage + '/index' + setUrlParams(argParams)
    // 匹配绝对路径和url
    if (argPage[0] === '/' || /http:\/\/|https:\/\//.test(argPage)) {
      temUrl = argPage + setUrlParams(argParams)
    }
    // #ifdef  H5
    type = 'h5'
    if (/http:\/\/|https:\/\//.test(argPage)) {
      temUrl = argPage + setUrlParams(argParams)
      window.location.replace(temUrl)
      return
    }
    // #endif
    switch (argType) {
      case 'switchTab':
        app.switchTab({
          url: temUrl,
        })
        break
      case 'reload':
        app.reLaunch({
          url: temUrl,
        })
        break
      case 'redirectTo':
        if (type === 'h5') {
          window.location.replace('#' + temUrl)
        } else {
          app.redirectTo({
            url: temUrl,
          })
        }
        break
      case 'reLaunch':
        app.reLaunch({
          url: temUrl,
        })
        break
      default:
        // 超10层处理
        // #ifndef H5
        if (pages &amp;&amp; pages.length >= 10) {
          app.redirectTo({
            url: temUrl,
          })
          return
        }
        // #endif
        app.navigateTo({
          url: temUrl,
        })
        break
    }
  }
  // #ifdef  H5
  argForce = true
  // #endif
  if (argForce) {
    toPageFn()
  } else {
    throttle.throttle(toPageFn)
  }
}

/**
 * @function
 * @description 当前页面数据obj
 * @returns {object}
 */
export const getCurrentPage = () => {
  var pages = getCurrentPages() || []
  return pages[pages.length - 1] || {}
}

/**
 * @function
 * @description 获取当前页url
 * @param {boolean} argWithParams 是否附带参数
 */
export const getCurrentPageUrl = (argWithParams) => {
  var currentPage = getCurrentPage()
  var url = currentPage.route
  var options = currentPage.options
  if (argWithParams) {
    url += this.urlParams(options)
  }
  return url
}

/**
 * @function
 * @description 获取微信登录code
 * @returns {promise}
 */
export const login = () => {
  return new Promise(function (resolve, reject) {
    app.login({
      timeout: 5000,
      success: function (rs) {
        app.setStorageSync('code', rs.code)
        console.info('login info:', rs)
        return resolve(rs)
      },
      fail: function (err) {
        toast('请检查网络')
        return reject(err)
      },
    })
  })
}
/**
 * @function
 * @description 获取用户信息
 * @param {object} argData 用户数据（点按钮授权时传入）
 * @returns {promise}
 */
export async function getUserInfo(argData) {
  L.loading(1)
  const _login = await login().catch((err) => {
    console.log(err)
    L.loading()
  })
  const setUserInfo = (argData) => {
    L.loading()
    return argData
  }
  if (argData) {
    if (argData.target) {
      argData.target.code = _login.code
    }
    return setUserInfo(argData.target)
  } else {
    const _checkSetting = await checkSetting('userInfo').catch((err) => {
      console.log('未授权', err)
      L.loading()
    })
    _checkSetting.code = _login.code
    return setUserInfo(_checkSetting)
  }
}

/**
 * @function
 * @description 选择图片
 * @param {object} argOptions 选择图片的配置
 * @returns {promise}
 */
export const chooseImage = (argOptions) => {
  return new Promise(function (resolve, reject) {
    const options = {
      success: (rs) => {
        return resolve(rs)
      },
      fail: (err) => {
        toast('请检查网络')
        return reject(err)
      },
    }
    app.chooseImage(Object.assign(options, argOptions))
  })
}

/**
 * @function
 * @description 下载图片到手机
 * @param {object} argImgList 图片url,数组或字符串
 * @param {object} argIsLocal 是否是本地临时文件路径或永久文件路径
 * @returns {promise} 出错时无promise
 */
export const downloadImgs = async (argImgList = [], argIsLocal = false) => {
  let isAuth = true
  let res = null
  if (argImgList &amp;&amp; typeof argImgList === 'string') {
    argImgList = [argImgList]
  }
  if (!argImgList.length) {
    console.log('参数有误！')
    return
  }
  L.loading(1)
  await checkSetting('writePhotosAlbum').catch((err) => {
    console.error(err)
    isAuth = false
    L.loading()
  })
  // 拒绝授权处理
  if (!isAuth) {
    res = await P('showModal', {
      title: '提示',
      content: '需要您授权保存相册',
      showCancel: false,
      async success() {
        const res = await P('openSetting')
        if (res.authSetting['scope.writePhotosAlbum']) {
          app.showModal({
            title: '提示',
            content: '已获得权限，请重新操作！',
            showCancel: false,
          })
          return true
        } else {
          app.showModal({
            title: '提示',
            content: '未获得权限，将无法保存到相册哦~',
            showCancel: false,
          })
          return false
        }
      },
    })
  }
  for (const img of argImgList) {
    let tempFilePath = img
    if (!argIsLocal) {
      res = await P('downloadFile', {
        url: img,
      })
      tempFilePath = res.tempFilePath
    }
    let saveFail = false
    await P('saveImageToPhotosAlbum', {
      filePath: tempFilePath,
    }).catch((err) => {
      saveFail = true
      console.error(err)
    })
    if (saveFail) {
      L.loading()
      toast('保存到相册失败，请重试！')
      return
    }
  }
  L.loading()
  await toast('下载完成！')
}
/**
 * @function
 * @description 上传图片，返回临时图片路径
 * @param {object} argOptions{
 * // 最多可以选择的图片张数
 *  count: 9,
 *  // 所选的图片的尺寸
 *  sizeType: ['original', 'compressed'],
 *  // album 从相册选图，camera 使用相机，默认二者都有。如需直接开相机或直接选相册，请只使用一个选项
 *  sourceType: ['album', 'camera'],
 *  // 是否关闭图片压缩，默认开启
 * disCompress: false,
 * } 外加选择图片chooseImage配置
 * @param {object} argMb 超过多少M压缩，默认1M(仅支持jpg)
 * @param {object} argQuality 压缩质量默认80
 * @param {object} argMaxSize 图片最长边默认1920
 * @returns {promise} 返回临时图片路径[{tempFilePath:'临时路径',size: '不压缩时返回'}]
 */
export const uploadImgs = async (
  argOptions = {
    // 最多可以选择的图片张数
    count: 9,
    // 所选的图片的尺寸
    sizeType: ['original', 'compressed'],
    // album 从相册选图，camera 使用相机，默认二者都有。如需直接开相机或直接选相册，请只使用一个选项
    sourceType: ['album', 'camera'],
    // 是否关闭图片压缩，默认开启
    disCompress: false,
  },
  argMb = 1,
  argQuality = 90,
  argMaxSize = 1920
) => {
  var maxSize = argMaxSize || 1920
  let err = ''
  const res = await P('chooseImage', {
    count: argOptions.count || 9,
    sizeType: argOptions.sizeType || ['original', 'compressed'],
    sourceType: argOptions.sourceType || ['album', 'camera'],
  }).catch((error) => {
    err = error
  })
  if (!res) {
    console.error(err)
    return Promise.reject(err)
  }
  console.log('选择文件：', res)
  showLoading()
  // 按需压缩
  const tempFiles = res.tempFiles
  // 压缩图片
  const compressImage = async (argData) => {
    console.error(argData.size, argMb)
    if (argData.size > argMb * 1024 * 1024) {
      console.log('未压缩前：', argData)
      // #ifndef H5
      if (!argOptions.disCompress) {
        return P('compressImage', {
          src: argData.path,
          quality: argQuality,
        })
      }
      // #endif
      const getBase64Image = async (argData) => {
        console.log('canvas压缩Start')
        var canvas = document.createElement('canvas')
        var img = argData.img
        let scaleRate
        if (img.width > img.height &amp;&amp; img.width > maxSize) {
          scaleRate = img.width / maxSize
          img.width = maxSize
          img.height = img.height / scaleRate
        }
        if (img.height > img.width &amp;&amp; img.height > maxSize) {
          scaleRate = img.height / maxSize
          img.height = maxSize
          img.width = img.width / scaleRate
        }
        canvas.width = img.width
        canvas.height = img.height
        var ctx = canvas.getContext('2d')
        ctx.drawImage(img, 0, 0, img.width, img.height)
        let rate = argQuality / 100
        // base64Url
        var base64Url = canvas.toDataURL('image/jpeg', rate)
        if (argOptions.reType === 'base64') {
          return {
            path: base64Url,
            file: null,
          }
        } else {
          var blob = await dataURLtoBlob(base64Url)
          var file = await blobToFile(blob, argData.name)
          console.warn(
            'old:',
            argData.size / 1024,
            'new:',
            base64Url.length / 1024,
            'fileSize:',
            file.size / 1024,
            file,
            typeof file
          )
          return {
            path: base64Url,
            file: file,
          }
        }
      }
      const loadImg = async (argData) => {
        return new Promise((resolve, reject) => {
          var img = new Image()
          img.src = argData.path
          // console.warn(img)
          img.onload = function () {
            return resolve({
              img,
              name: argData.name || '',
            })
          }
        })
      }
      let file = await getBase64Image(await loadImg(argData))
      if (safeData(file, 'file.size') > argMb * 1024 * 1024) {
        console.log('二次压缩', file)
        // 控制质量
        argQuality = argQuality / 2
        // 控制大小
        // maxSize = maxSize / 2
        file = await getBase64Image(await loadImg(file))
      }
      return Promise.resolve({
        // 临时路径
        tempFilePath: file.path,
        file: file.file,
        fileName: argData.name || '',
        // 大小
        size: file.size,
      })
    }
    return Promise.resolve({
      tempFilePath: argData.path,
      size: argData.size,
      fileName: argData.name || '',
      file: argData,
    })
  }

  const tempFilePathsFn = tempFiles.map(compressImage)
  let tempFilePaths = []
  tempFilePaths = await Promise.all(tempFilePathsFn).catch((error) => {
    // console.error(error)
    err = error
  })
  hideLoading()
  if (!tempFilePaths) {
    return Promise.reject(err)
  }
  return Promise.resolve(tempFilePaths)
}

/**
 * @function
 * @description 检测浏览器状态，系统状态 *
 * @returns {object} {
 * ua: ua,
 * platform: 平台,
 * isMobile: 移动端,
 * isWin: winPC端,
 * isIphone: iphone,
 * isIpad: ipad,
 * isMac: mac,
 * isAppleMobile: 苹果移动端webview
 * isSafari: Safari浏览器,
 * isIos: Ios平台,
 * isAndroid: android平台,
 * isIE: 显示8 9 10, true为11以上
 * ...
 * }
 */
export const getSystemInfo = () => {
  let info = {}
  if (typeof app === 'object' &amp;&amp; safeData(app, 'getSystemInfoSync')) {
    info = app.getSystemInfoSync()
    info.platform = info.platform.toLowerCase()
    info.isIos = info.platform === 'ios'
    info.isAndroid = info.platform === 'android'
    info.iosVersion =
      info.isIos &amp;&amp; info.system.match(/\d./) &amp;&amp; info.system.match(/\d./)[0]
    // #ifdef H5
    info.ua = safeData(navigator, 'userAgent', '').toLowerCase()
    info.isWeixin = !!info.ua.match(/MicroMessenger/i)
    info.isAlipay = info.ua.match(/Alipay/i) === 'alipay'
    // #endif
    return info
  }
  const ua = navigator.userAgent.toLowerCase()
  const platform = navigator.platform.toLowerCase()
  info = {
    ua: ua,
    platform: platform,
    isWeixin: ua.match(/MicroMessenger/i) &amp;&amp; true,
    isAlipay: ua.match(/Alipay/i) &amp;&amp; true,
    isMobile: ua.match(/mobile/i) &amp;&amp; true,
    isWin: platform.match(/win/i) &amp;&amp; true,
    isIphone: ua.match(/iphone/i) &amp;&amp; true,
    isIpad: ua.match(/ipad/i) &amp;&amp; true,
    isMac: platform.match('mac') &amp;&amp; true,
    isIos: platform.match('ios') &amp;&amp; true,
    isAndroid: platform.match('android') &amp;&amp; true,
    isSafari: ua.indexOf('safari') > -1 &amp;&amp; ua.indexOf('chrome') &lt; 1,
    isIE: !!window.ActiveXObject || 'ActiveXObject' in window,
  }
  if (info.ua.match('msie')) {
    const IE = info.ua.match(/msie\s([0-9]*)/)
    if (IE.length >= 2) {
      info.isIe = IE[1]
    }
  }
  info.isAppleMobile =
    info.isMobile &amp;&amp;
    ua.toLowerCase().indexOf('applewebkit') &amp;&amp;
    ua.indexOf('chrome') &lt; 1
  info = Object.assign(navigator, info)
  return info
}

/**
 * @function
 * @description 小程序云函数记录日志（需要添加云函数log，弃用）
 * @param {object} argData log内容
 */
export const log = async (...argData) => {
  try {
    const systemInfo = getSystemInfo()
    console.log(systemInfo)
    if (frame === 'wx') {
      // 只有不在开发工具上触发的才上报
      if (systemInfo.platform !== 'devtools') {
        const systemInfo = getSystemInfo()
        const res = await app.getNetworkType()
        await wx.cloud
          .callFunction({
            name: 'log',
            data: {
              clientType: systemInfo.model,
              systemInfo: JSON.stringify(systemInfo),
              pageRoute: getCurrentPage().route,
              message: [...argData],
              networkType: res.networkType,
              errorTime: new Date(),
            },
          })
          .catch((err) => console.error(err))
      }
    } else {
      console.error(...argData)
    }
  } catch (err) {
    console.error(err)
  }
}

/**
 * @function
 * @description 获取storage的值，默认将json转为obj
 * @param {string} argKey 要获取的key
 * @param {string} argNoJson true时不自动转换JSON字符串
 * @returns {promise} key对应的数据
 */
export const getStorage = async (argKey, argNoJson) => {
  let res = await P('getStorage', {
    key: argKey,
  })
  if (appConfig.localEncrypt) {
    res = decode(res.data)
  }
  if (!res || !res.data) {
    log(['获取失败', res])
  }
  // 默认转义JSON字符串
  if (!argNoJson &amp;&amp; isJson(res.data)) {
    res.data = JSON.parse(res.data)
  }
  return res.data || res || ''
}

/**
 * @function
 * @description 获取storage的值，默认将json转为obj
 * @param {string} argKey 要获取的key
 * @param {string} argNoJson true时不自动转换JSON字符串
 * @returns {data} key对应的数据
 */
export const getStorageSync = (argKey, argNoJson) => {
  let data = app.getStorageSync(argKey)
  if (appConfig.localEncrypt) {
    data = decode(data)
  }
  // 默认转义JSON字符串
  if (!argNoJson &amp;&amp; isJson(data)) {
    data = JSON.parse(data)
  }
  return data
}

/**
 * @function
 * @description 退出登录或登录失效，清除本地数据
 * @param {string} argKey 要删除的key,不填为删除全部
 * @param {string} argExtraKey:额外保留的key如：'vuex,ticket'
 * @returns {data} key对应的数据
 */
export const clearStorageSync = async (argKey = '', argExtraKey = {}) => {
  if (argKey) {
    app.removeStorageSync(argKey)
  } else {
    let res = await P('getStorageInfo')
    res.keys.map((v) => {
      if (!argData.force) {
        let extraKey = ',' + argExtraKey + ','
        if (extraKey.match(',' + v + ',')) {
          return
        }
      }
      app.removeStorageSync(v)
    })
  }
}
/**
 * @function
 * @description 获取storage的值
 * @param {string} argKey 要获取的key
 * @returns {promise} key对应的数据
 */
export const getStorageSyncForVuex = (argKey) => {
  let data = app.getStorageSync(argKey)
  if (appConfig.localEncrypt) {
    data = decode(data)
  }
  return data
}

/**
 * @function
 * @description 设置storage的值，默认将obj转为json
 * @param {string} argKey 要设置的key
 * @param {string} argData 要设置的值
 * @returns {promise} key对应的数据
 */
export const setStorage = async (argKey, argData) => {
  let temData = argData
  if (appConfig.localEncrypt) {
    temData = encode(argData)
  }
  const res = await P('setStorage', {
    key: argKey,
    data: temData,
  }).catch((err) => {
    console.error(err)
    log(['setStorage失败', res])
  })
  return res.data || res || ''
}

/**
 * @function
 * @description wx api转Promise
 * @param {object} argApi 需要转promise的API名称
 * @param {object} argOptions api对应的配置，除了success和fail
 * @returns {promise}
 */
export const P = (argApi, argOptions) => {
  return new Promise(function (resolve, reject) {
    if (!argApi &amp;&amp; argOptions.success) {
      return argOptions.success(resolve, reject)
    }
    const options = {
      success: resolve,
      fail: reject,
    }
    Object.assign(options, argOptions)
    if (app[argApi]) {
      app[argApi](options)
    } else {
      return Promise.reject('无此方法')
    }
  })
}

/**
 * 描述
 * @function
 * @description 微信实时日志记录
 * @date 2019-09-26
 * @returns {functions}
 */
export const ljLog = () => {
  // logLevel 1 error 2 warn 3 info 4 debug
  const logLevel = +getStorageSync('logLevel')
  switch (logLevel) {
    case 1:
      console.warn = () => {}
    // eslint-disable-next-line no-fallthrough
    case 2:
      console.info = () => {}
    // eslint-disable-next-line no-fallthrough
    case 3:
      console.log = () => {}
    // eslint-disable-next-line no-fallthrough
    case 4:
    case 0:
    default:
      break
  }
  if (!wx) {
    return
  }
  const log = wx.getRealtimeLogManager ? wx.getRealtimeLogManager() : null
  if (!log) {
    console.log('实时日志未生效')
    return null
  }
  return {
    debug() {
      // console.log(arguments)
      if (!log) return
      log.debug.apply(log, arguments)
    },
    info() {
      // console.log(arguments)
      if (!log) return
      log.info.apply(log, arguments)
    },
    warn() {
      // console.log(arguments)
      if (!log) return
      log.warn.apply(log, arguments)
    },
    error() {
      // console.log(arguments)
      if (!log) return
      log.error.apply(log, arguments)
    },
    setFilterMsg(msg) {
      // 从基础库2.7.3开始支持
      if (!log || !log.setFilterMsg) return
      if (typeof msg !== 'string') return
      log.setFilterMsg(msg)
    },
    addFilterMsg(msg) {
      // 从基础库2.8.1开始支持
      if (!log || !log.addFilterMsg) return
      if (typeof msg !== 'string') return
      log.addFilterMsg(msg)
    },
  }
}
/**
 * 描述
 * @function
 * @description 小程序云函数调用
 * @date 2019-09-26
 * @returns {functions}
 */
export const cloudApi = async (argOption = {}) => {
  if (wx) {
    L.loading(1)
    let error = ''
    const res = await wx.cloud.callFunction(argOption).catch((err) => {
      toast(`云函数:${argOption.name}调用失败！`)
      error = err
    })
    L.loading()
    if (error) {
      return Promise.reject(error)
    }
    return Promise.resolve(res)
  } else {
    return Promise.reject('暂不支持')
  }
}
/**
 * @function
 * @description 富文本格式处理 for 小程序rich-text
 * @param {*} argData 富文本
 * @returns {String}
 */
export const getRichText = (argData) => {
  if (!argData) {
    return ''
  }
  const imgReg = /&lt;img.*?(?:>|\/>)/gi
  const styleReg = /style="([^"]*)"/g
  // 处理空格
  argData = argData.replace(/&amp;nbsp;/g, '\xa0')
  argData = String(argData).replace(imgReg, (match) => {
    let newStyleImg = ''
    // 图片样式保留原来style添加大小限制，若原来img没有设style则直接插进去
    if (!match.match('max-width:100%')) {
      let temStyle = safeData(match.match(styleReg), '0', '')
      if (temStyle) {
        temStyle =
          temStyle.slice(0, temStyle.length - 1) +
          ';max-width:100%;height:auto;"'
        newStyleImg = match.replace(styleReg, temStyle)
      } else {
        newStyleImg = match.replace(
          /&lt;img/gim,
          '&lt;img style="max-width:100%;height:auto;"'
        )
      }
    } else {
      newStyleImg = match
    }
    // #ifdef MP
    // newStyleImg = newStyleImg.replace(/px;/gim, 'rpx;')
    // #endif
    return newStyleImg
  })
  return argData
}
/**
 * @function
 * @description 页面刷新
 */
export const refresh = () => {
  let nowPage = getCurrentPage()
  let options = getUrlParamObj(safeData(nowPage, '$page.fullPath'))
  nowPage.onLoad &amp;&amp; nowPage.onLoad(options)
  nowPage.onReady &amp;&amp; nowPage.onReady()
  nowPage.onShow &amp;&amp; nowPage.onShow()
}
export const APP = app
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> on Wed Mar 23 2022 08:49:09 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
